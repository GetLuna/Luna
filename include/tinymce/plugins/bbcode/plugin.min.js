/**
 * plugin.js
 *
 * Copyright, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */

/*global tinymce:true */

(function() {
	tinymce.create('tinymce.plugins.BBCodePlugin', {
		init : function(ed) {
			var t = this, dialect = ed.getParam('bbcode_dialect', 'punbb').toLowerCase();

			ed.on('beforeSetContent', function(e) {
				e.content = t['_' + dialect + '_bbcode2html'](e.content);
			});

			ed.on('postProcess', function(e) {
				if (e.set) {
					e.content = t['_' + dialect + '_bbcode2html'](e.content);
				}

				if (e.get) {
					e.content = t['_' + dialect + '_html2bbcode'](e.content);
				}
			});
		},

		getInfo: function() {
			return {
				longname: 'BBCode Plugin',
				author: 'Moxiecode Systems AB',
				authorurl: 'http://www.tinymce.com',
				infourl: 'http://www.tinymce.com/wiki.php/Plugin:bbcode'
			};
		},

		// Private methods

		// HTML -> BBCode in ModernBB dialect
		_punbb_html2bbcode : function(s) {
			s = tinymce.trim(s);

			function rep(re, str) {
				s = s.replace(re, str);
			}

			// example: <strong> to [b]
			rep(/<a.*?href=\"(.*?)\".*?>(.*?)<\/a>/gi,"[url=$1]$2[/url]");
			rep(/<span style=\"color: ?(.*?);\">(.*?)<\/span>/gi,"[color=$1]$2[/color]");
			rep(/<font.*?color=\"(.*?)\".*?>(.*?)<\/font>/gi,"[color=$1]$2[/color]");
			rep(/<span style=\"text-decoration: line-through;\">(.*?)<\/span>/gi,"[s]$1[/s]");
			rep(/<font>(.*?)<\/font>/gi,"$1");
			rep(/<img src=\"(.*?)\" .*?alt="(.*?)".*? \/>/gi,"[img]$1[/img]");
			rep(/<pre>(.*?)<\/pre>/gi,"[code]$1[/code]");
			rep(/<code>(.*?)<\/code>/gi,"[c]$1[/c]");
			rep(/<p style=\"text-align: center;\">(.*?)<\/p>/gi,"[center]$1[/center]");
			rep(/<p style=\"text-align: right;\">(.*?)<\/p>/gi,"[right]$1[/right]");
			rep(/<p style=\"text-align: justify;\">(.*?)<\/p>/gi,"[justify]$1[/justify]");
			rep(/<h1 style=\"text-align: center;\">(.*?)<\/h1>/gi,"[h1][center]$1[/center][/h1]");
			rep(/<h1 style=\"text-align: right;\">(.*?)<\/h1>/gi,"[h1][right]$1[/right][/h1]");
			rep(/<h1 style=\"text-align: justify;\">(.*?)<\/h1>/gi,"[h1][justify]$1[/justify][/h1]");
			rep(/<h2 style=\"text-align: center;\">(.*?)<\/h2>/gi,"[h2][center]$1[/center][/h2]");
			rep(/<h2 style=\"text-align: right;\">(.*?)<\/h2>/gi,"[h2][right]$1[/right][/h2]");
			rep(/<h2 style=\"text-align: justify;\">(.*?)<\/h2>/gi,"[h2][justify]$1[/justify][/h2]");
			rep(/<h3 style=\"text-align: center;\">(.*?)<\/h3>/gi,"[h3][center]$1[/center][/h3]");
			rep(/<h3 style=\"text-align: right;\">(.*?)<\/h3>/gi,"[h3][right]$1[/right][/h3]");
			rep(/<h3 style=\"text-align: justify;\">(.*?)<\/h3>/gi,"[h3][justify]$1[/justify][/h3]");
			rep(/<h4 style=\"text-align: center;\">(.*?)<\/h4>/gi,"[h4][center]$1[/center][/h4]");
			rep(/<h4 style=\"text-align: right;\">(.*?)<\/h4>/gi,"[h4][right]$1[/right][/h4]");
			rep(/<h4 style=\"text-align: justify;\">(.*?)<\/h4>/gi,"[h4][justify]$1[/justify][/h4]");
			rep(/<h5 style=\"text-align: center;\">(.*?)<\/h5>/gi,"[h5][center]$1[/center][/h5]");
			rep(/<h5 style=\"text-align: right;\">(.*?)<\/h5>/gi,"[h5][right]$1[/right][/h5]");
			rep(/<h5 style=\"text-align: justify;\">(.*?)<\/h5>/gi,"[h5][justify]$1[/justify][/h5]");
			rep(/<h6 style=\"text-align: center;\">(.*?)<\/h6>/gi,"[h6][center]$1[/center][/h6]");
			rep(/<h6 style=\"text-align: right;\">(.*?)<\/h6>/gi,"[h6][right]$1[/right][/h6]");
			rep(/<h6 style=\"text-align: justify;\">(.*?)<\/h6>/gi,"[h6][justify]$1[/justify][/h6]");
			rep(/<p style=\"text-align: left;\">/gi,"");
			rep(/<\/(ol|ul)>/gi,"[/list]");
			rep(/<ol>/gi,"[list=1]");
			rep(/<ul>/gi,"[list=*]");
			rep(/<ol style=\"list-style-type: lower-alpha;\">/gi,"[list=a]");
			rep(/<\/(strong|b)>/gi,"[/b]");
			rep(/<(strong|b)>/gi,"[b]");
			rep(/<\/(em|i)>/gi,"[/i]");
			rep(/<(em|i)>/gi,"[i]");
			rep(/<\/u>/gi,"[/u]");
			rep(/<h1>/gi,"[h1]");
			rep(/<\/h1>/gi,"[/h1]");
			rep(/<h2>/gi,"[h2]");
			rep(/<\/h2>/gi,"[/h2]");
			rep(/<h3>/gi,"[h3]");
			rep(/<\/h3>/gi,"[/h3]");
			rep(/<h4>/gi,"[h4]");
			rep(/<\/h4>/gi,"[/h4]");
			rep(/<h5>/gi,"[h5]");
			rep(/<\/h5>/gi,"[/h5]");
			rep(/<h6>/gi,"[h6]");
			rep(/<\/h6>/gi,"[/h6]");
			rep(/<sub>/gi,"[sub]");
			rep(/<\/sub>/gi,"[/sub]");
			rep(/<sup>/gi,"[sup]");
			rep(/<\/sup>/gi,"[/sup]");
			rep(/<li>/gi,"[\*]");
			rep(/<\/li>/gi,"[/\*]");
			rep(/<span style=\"text-decoration: ?underline;\">(.*?)<\/span>/gi,"[u]$1[/u]");
			rep(/<u>/gi,"[u]");
			rep(/<blockquote><footer><cite>(.*?)<\/cite><\/footer>/gi,"[quote=$1]");
			rep(/<blockquote>/gi,"[quote]");
			rep(/<\/blockquote>/gi,"[/quote]");
			rep(/<br \/><br \/>/gi,"\n");;
			rep(/<br \/>/gi,"\n");
			rep(/<br\/>/gi,"\n");
			rep(/<br>/gi,"\n");
			rep(/<p>/gi,"");
			rep(/<\/p>/gi,"");
			rep(/&quot;/gi,"\"");
			rep(/&lt;/gi,"<");
			rep(/&gt;/gi,">");
			rep(/&amp;/gi,"&");
			rep(/&hellip;/gi,"…");
			rep(/&nbsp;/gi," ");
			rep(/  /gi," ");
			// Emoticons from BBCode img to BBCode
			rep(/\[img\]style\/Core\/img\/smilies\/smile.png\[\/img\]/gi,":)");
			rep(/\[img\]style\/Core\/img\/smilies\/neutral.png\[\/img\]/gi,":|");
			rep(/\[img\]style\/Core\/img\/smilies\/sad.png\[\/img\]/gi,":(");
			rep(/\[img\]style\/Core\/img\/smilies\/big_smile.png\[\/img\]/gi,":D");
			rep(/\[img\]style\/Core\/img\/smilies\/yikes.png\[\/img\]/gi,":o");
			rep(/\[img\]style\/Core\/img\/smilies\/wink.png\[\/img\]/gi,";)");
			rep(/\[img\]style\/Core\/img\/smilies\/hmm.png\[\/img\]/gi,":/");
			rep(/\[img\]style\/Core\/img\/smilies\/tongue.png\[\/img\]/gi,":p");
			rep(/\[img\]style\/Core\/img\/smilies\/lol.png\[\/img\]/gi,":lol:");
			rep(/\[img\]style\/Core\/img\/smilies\/mad.png\[\/img\]/gi,":@");
			rep(/\[img\]style\/Core\/img\/smilies\/roll.png\[\/img\]/gi,"%)");
			rep(/\[img\]style\/Core\/img\/smilies\/cool.png\[\/img\]/gi,":cool:");
			rep(/\[img\]style\/Core\/img\/smilies\/happycry.png\[\/img\]/gi,":hc:");
			rep(/\[img\]style\/Core\/img\/smilies\/angel.png\[\/img\]/gi,"(A)");
			rep(/\[img\]style\/Core\/img\/smilies\/ohyeah.png\[\/img\]/gi,"^-^");
			rep(/\[img\]style\/Core\/img\/smilies\/happy.png\[\/img\]/gi,"^.^");
			// Emoticons from HTML to BBCode
			rep(/<img src="style\/Core\/img\/smilies\/smile.png" \/>/gi,":)");
			rep(/<img src="style\/Core\/img\/smilies\/neutral.png" \/>/gi,":|");
			rep(/<img src="style\/Core\/img\/smilies\/sad.png" \/>/gi,":(");
			rep(/<img src="style\/Core\/img\/smilies\/big_smile.png" \/>/gi,":D");
			rep(/<img src="style\/Core\/img\/smilies\/yikes.png" \/>/gi,":o");
			rep(/<img src="style\/Core\/img\/smilies\/wink.png" \/>/gi,";)");
			rep(/<img src="style\/Core\/img\/smilies\/hmm.png" \/>/gi,"(:/)");
			rep(/<img src="style\/Core\/img\/smilies\/tongue.png" \/>/gi,":p");
			rep(/<img src="style\/Core\/img\/smilies\/lol.png" \/>/gi,":lol:");
			rep(/<img src="style\/Core\/img\/smilies\/mad.png" \/>/gi,":@");
			rep(/<img src="style\/Core\/img\/smilies\/roll.png" \/>/gi,"%)");
			rep(/<img src="style\/Core\/img\/smilies\/cool.png" \/>/gi,":cool:");
			rep(/<img src="style\/Core\/img\/smilies\/happycry.png" \/>/gi,":hc:");
			rep(/<img src="style\/Core\/img\/smilies\/angel.png" \/>/gi,"(A)");
			rep(/<img src="style\/Core\/img\/smilies\/ohyeah.png" \/>/gi,"^-^");
			rep(/<img src="style\/Core\/img\/smilies\/happy.png" \/>/gi,"^.^");

			return s;
		},

		// BBCode -> HTML from ModernBB dialect
		_punbb_bbcode2html : function(s) {
			s = tinymce.trim(s);

			function rep(re, str) {
				s = s.replace(re, str);
			}

			// example: [b] to <strong>
			rep(/\[b\]/gi,"<strong>");
			rep(/\[\/b\]/gi,"</strong>");
			rep(/\[i\]/gi,"<em>");
			rep(/\[\/i\]/gi,"</em>");
			rep(/\[ins\]/gi,"<ins>");
			rep(/\[\/ins\]/gi,"</ins>");
			rep(/\[u\]/gi,"<u>");
			rep(/\[\/u\]/gi,"</u>");
			rep(/\[h1\]/gi,"<h1>");
			rep(/\[\/h1\]/gi,"</h1>");
			rep(/\[h2\]/gi,"<h2>");
			rep(/\[\/h2\]/gi,"</h2>");
			rep(/\[h3\]/gi,"<h3>");
			rep(/\[\/h3\]/gi,"</h3>");
			rep(/\[h4\]/gi,"<h4>");
			rep(/\[\/h4\]/gi,"</h4>");
			rep(/\[h5\]/gi,"<h5>");
			rep(/\[\/h5\]/gi,"</h5>");
			rep(/\[h6\]/gi,"<h6>");
			rep(/\[\/h6\]/gi,"</h6>");
			rep(/\[del\]/gi,"<del>");
			rep(/\[\/del\]/gi,"</del>");
			rep(/\[sub\]/gi,"<sub>");
			rep(/\[\/sub\]/gi,"</sub>");
			rep(/\[sup\]/gi,"<sup>");
			rep(/\[\/sup\]/gi,"</sup>");
			rep(/\[\*\]/gi,"<li>");
			rep(/\[\/\*\]\n/gi,"</li>");
			rep(/\[list=a\]\n/gi,"<ol style=\"list-style-type: lower-alpha\">");
			rep(/\[list=1\]\n/gi,"<ol>");
			rep(/\[list=\*\]\n/gi,"<ul>");
			rep(/\[\/list\]/gi,"</ol>");
			rep(/\[center\](.*?)\[\/center\]/gi,"<p style=\"text-align: center;\">$1</p>");
			rep(/\[right\](.*?)\[\/right\]/gi,"<p style=\"text-align: right;\">$1</p>");
			rep(/\[justify\](.*?)\[\/justify\]/gi,"<p style=\"text-align: justify;\">$1</p>");
			rep(/\[h1]\[center\](.*?)\[\/center\]\[\/h1]/gi,"</p><h1 style=\"text-align: center;\">$1</h1><p>");
			rep(/\[h1]\[right\](.*?)\[\/right\]\[\/h1]/gi,"</p><h1 style=\"text-align: right;\">$1</h1><p>");
			rep(/\[h1]\[justify\](.*?)\[\/justify\]\[\/h1]/gi,"</p><h1 style=\"text-align: justify;\">$1</h1><p>");
			rep(/\[h2]\[center\](.*?)\[\/center\]\[\/h2]/gi,"</p><h2 style=\"text-align: center;\">$1</h2><p>");
			rep(/\[h2]\[right\](.*?)\[\/right\]\[\/h2]/gi,"</p><h2 style=\"text-align: right;\">$1</h2><p>");
			rep(/\[h2]\[justify\](.*?)\[\/justify\]\[\/h2]/gi,"</p><h2 style=\"text-align: justify;\">$1</h2><p>");
			rep(/\[h3]\[center\](.*?)\[\/center\]\[\/h3]/gi,"</p><h3 style=\"text-align: center;\">$1</h3><p>");
			rep(/\[h3]\[right\](.*?)\[\/right\]\[\/h3]/gi,"</p><h3 style=\"text-align: right;\">$1</h3><p>");
			rep(/\[h3]\[justify\](.*?)\[\/justify\]\[\/h3]/gi,"</p><h3 style=\"text-align: justify;\">$1</h3><p>");
			rep(/\[h4]\[center\](.*?)\[\/center\]\[\/h4]/gi,"</p><h4 style=\"text-align: center;\">$1</h4><p>");
			rep(/\[h4]\[right\](.*?)\[\/right\]\[\/h4]/gi,"</p><h4 style=\"text-align: right;\">$1</h4><p>");
			rep(/\[h4]\[justify\](.*?)\[\/justify\]\[\/h4]/gi,"</p><h4 style=\"text-align: justify;\">$1</h4><p>");
			rep(/\[h5]\[center\](.*?)\[\/center\]\[\/h5]/gi,"</p><h5 style=\"text-align: center;\">$1</h5><p>");
			rep(/\[h5]\[right\](.*?)\[\/right\]\[\/h5]/gi,"</p><h5 style=\"text-align: right;\">$1</h5><p>");
			rep(/\[h5]\[justify\](.*?)\[\/justify\]\[\/h5]/gi,"</p><h5 style=\"text-align: justify;\">$1</h5><p>");
			rep(/\[h6]\[center\](.*?)\[\/center\]\[\/h6]/gi,"</p><h6 style=\"text-align: center;\">$1</h6><p>");
			rep(/\[h6]\[right\](.*?)\[\/right\]\[\/h6]/gi,"</p><h6 style=\"text-align: right;\">$1</h6><p>");
			rep(/\[h6]\[justify\](.*?)\[\/justify\]\[\/h6]/gi,"</p><h6 style=\"text-align: justify;\">$1</h6><p>");
			rep(/\[s\](.*?)\[\/s\]/gi,"<span style=\"text-decoration: line-through;\">$1</span>");
			rep(/\[url=([^\]]+)\](.*?)\[\/url\]/gi,"<a href=\"$1\">$2</a>");
			rep(/\[url\](.*?)\[\/url\]/gi,"<a href=\"$1\">$1</a>");
			rep(/\[img=([^\]]+)\]([^\]]+)\[\/img\]/gi,"<img src=\"$2\" alt=\"$1\" />");
			rep(/\[img]([^\]]+)\[\/img\]/gi,"<img src=\"$1\" />");
			rep(/\[color=(.*?)\](.*?)\[\/color\]/gi,"<font color=\"$1\">$2</font>");
			rep(/\[code\](.*?)\[\/code\]/gi,"<pre>$1</pre>");
			rep(/\[c\](.*?)\[\/c\]/gi,"<code>$1</code>");
			rep(/\[quote=(.*?)\]/gi,"<blockquote><footer><cite>$1</cite></footer>");
			rep(/\[quote\]/gi,"<blockquote>");
			rep(/\[\/quote\]/gi,"</blockquote>");
			rep(/\n/gi,"<br />");
			// Emoticons from BBCode to HTML
			rep(/\:\)/gi,"<img src=\"style/Core/img/smilies/smile.png\" />");
			rep(/\=\)/gi,"<img src=\"style/Core/img/smilies/smile.png\" />");
			rep(/\:\|/gi,"<img src=\"style/Core/img/smilies/neutral.png\" />");
			rep(/\=\|/gi,"<img src=\"style/Core/img/smilies/neutral.png\" />");
			rep(/\:\(/gi,"<img src=\"style/Core/img/smilies/sad.png\" />");
			rep(/\=\(/gi,"<img src=\"style/Core/img/smilies/sad.png\" />");
			rep(/\:D/gi,"<img src=\"style/Core/img/smilies/big_smile.png\" />");
			rep(/\=D/gi,"<img src=\"style/Core/img/smilies/big_smile.png\" />");
			rep(/\:o/gi,"<img src=\"style/Core/img/smilies/yikes.png\" />");
			rep(/\:O/gi,"<img src=\"style/Core/img/smilies/yikes.png\" />");
			rep(/\;\)/gi,"<img src=\"style/Core/img/smilies/wink.png\" />");
			rep(/\(:\/\)/gi,"<img src=\"style/Core/img/smilies/hmm.png\" />");
			rep(/\:p/gi,"<img src=\"style/Core/img/smilies/tongue.png\" />");
			rep(/\:P/gi,"<img src=\"style/Core/img/smilies/tongue.png\" />");
			rep(/\:lol:/gi,"<img src=\"style/Core/img/smilies/lol.png\" />");
			rep(/\:\)\)/gi,"<img src=\"style/Core/img/smilies/lol.png\" />");
			rep(/\:-\)\)/gi,"<img src=\"style/Core/img/smilies/lol.png\" />");
			rep(/\:@/gi,"<img src=\"style/Core/img/smilies/mad.png\" />");
			rep(/\:mad:/gi,"<img src=\"style/Core/img/smilies/mad.png\" />");
			rep(/\%\)/gi,"<img src=\"style/Core/img/smilies/roll.png\" />");
			rep(/\:rolleyes:\)/gi,"<img src=\"style/Core/img/smilies/roll.png\" />");
			rep(/\:cool:/gi,"<img src=\"style/Core/img/smilies/cool.png\" />");
			rep(/b:/gi,"<img src=\"style/Core/img/smilies/cool.png\" />");
			rep(/B:/gi,"<img src=\"style/Core/img/smilies/cool.png\" />");
			rep(/\:hc:/gi,"<img src=\"style/Core/img/smilies/happycry.png\" />");
			rep(/\(A\)/gi,"<img src=\"style/Core/img/smilies/angel.png\" />");
			rep(/\(a\)/gi,"<img src=\"style/Core/img/smilies/angel.png\" />");
			rep(/\^-\^/gi,"<img src=\"style/Core/img/smilies/ohyeah.png\" />");
			rep(/\^.\^/gi,"<img src=\"style/Core/img/smilies/happy.png\" />");
			rep(/…/gi,"…");

			return s;
		}
	});

	// Register plugin
	tinymce.PluginManager.add('bbcode', tinymce.plugins.BBCodePlugin);
})();