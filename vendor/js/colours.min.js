(function(t){"use strict";var e=function(e,i){var s=this;this.popup_class="color-popup",this.element_class="color-picker",this.disabled_class="disabled",this.open_class="active",this.caption_class="rcp-caption",this.color_class="rcp-color",this.input_class="rcp-input",this.bottom_class="rcp-bottom",this.error_class="rcp-error",this.$element=t(e),this.$popup=void 0,this.$color=void 0,this.$caption=void 0,this.$input=void 0,this.isOpen=!1,this.caption=i.caption||this.$element.text()||this.$element.data("caption"),this.name=i.name||this.$element.data("name")||this.$element.attr("id")||"color_picker",this.palette=this._parsePalette(i.palette||this.$element.data("palette")||"black, white"),this.color=i.color||this.$element.data("color")||this.palette[0],this.show_field=i.show_field||this.$element.data("show-field")||!1,this.width=i.width||this.$element.data("width")||0,this.disabled=this.$element.attr("disabled")||!1,i.disabled!==void 0&&(this.disabled=i.disabled),this.palette_row_count=i.palette_row_count||this.$element.data("palette-row-count")||5,this.palette_size=i.palette_size||this.$element.data("palette-size")||42,this.onColorSelect=i.onColorSelect||function(){},this.onColorChange=i.onColorChange||function(){},this.onPaletteOver=i.onPaletteOver||function(){},this.onPaletteOut=i.onPaletteOut||function(){},this.init(),t(document).mouseup(function(t){var e=s.$popup;t.target.className!==s.input_class&&(e.hide(),s.$element.removeClass(s.open_class),s._checkValidInput(),setTimeout(function(){e.is(":hidden")&&(s.isOpen=!1)},200))})};e.prototype={constructor:e,init:function(){var e=this;if(this.$element.is("input")){var i=this.$element;this.name=i.attr("name")||this.name,this.color=i.attr("value")||this.color,this.$element=t("<div/>").insertBefore(i),i.remove()}return this.$caption=t("<div/>").addClass(this.caption_class).text(this.caption),this.$element.addClass(this.element_class).text(""),this.$color=t("<div/>").addClass(this.color_class).css("background-color",this.color),this.$element.append([this.$caption,this.$color]),this.$popup=this._createPopup(),this._resizePopup(),this._bindPaletteCallbacks(),this.width&&this.$element.css("width",this.width),this.$element.on("click",function(){e._changePopupPosition(),e.isOpen?e.close():e.disabled||e.open()}),this.disabled&&this.disable(),this},refresh:function(t){return this.$color.css("background-color",this.color),this.$input.val(this.color),this.$input.attr("name",this.name),this.$caption.text(this.caption),this.width&&this.$element.css("width",this.width),this.disabled?this.disable():this.enable(),t&&(this.palette=this._parsePalette(this.palette),this.$popup.find("> div").remove(),this._createPalette(this.$popup),this._resizePopup(),this._bindPaletteCallbacks(),-1===this.palette.indexOf(this.color)&&(this.color=this.palette[0],this.refresh())),this},_rgb2hex:function(t){var e=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],i=function(t){return isNaN(t)?"00":e[(t-t%16)/16]+e[t%16]};return"#"===t[0]?t:this._isColor(t)?"#"+t:(t=t.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),"#"+i(t[1])+i(t[2])+i(t[3]))},_checkValidInput:function(){this._isColor(this.$input.val())||this.$input.val(this._rgb2hex(this.color)),this.$input.removeClass(this.error_class)},_parsePalette:function(e){if(t.isArray(e))return e;for(var i=e.split(","),s=0;i.length>s;s++)i[s]=t.trim(i[s]);return i},_bindPaletteCallbacks:function(){var e=this,i=this.$popup.find("> span");t.each(i,function(i,s){var o=t(s);o.unbind("mouseover").on("mouseover",function(){return e.onPaletteOver(e._rgb2hex(o.css("background-color")))}),o.unbind("mouseout").on("mouseout",function(){return e.onPaletteOut(e._rgb2hex(o.css("background-color")))})})},_changeColor:function(t){var e=this.$color.css("background-color");this.$color.css("background-color",t),this.$input.val(this._rgb2hex(t)),this.onColorSelect(this._rgb2hex(t)),e!==t&&this.onColorChange(this._rgb2hex(t)),this.color=t},_createPalette:function(e){for(var i=this,s=0;i.palette.length>s;s++){var o=t("<span/>").css({"background-color":i.palette[s],width:i.palette_size,height:i.palette_size});o.on("click",function(e){var s=t(this).css("background-color");i._changeColor(s),i.close(),e.stopPropagation(),e.preventDefault()}),e.append(o)}return this},_resizePopup:function(){var e=t(this.$popup.find(">:first-child")[0]),i=e.outerWidth(!0)*this.palette_row_count+1;return this.$popup.css("max-width","266px"),this},_isColor:function(t){return/(^#{0,1}[0-9A-F]{6}$)|(^#{0,1}[0-9A-F]{3}$)/i.test(t)},_createInputField:function(){this.$input=t("<input/>").attr("type","text").addClass(this.input_class).attr("name",this.name).val(this.color).on("click",function(t){t.stopPropagation()});var e=this;return this.$input.on("keyup",function(t){var i=e.$input.val();e._isColor(i)?(e._changeColor(i),e.$input.removeClass(e.error_class)):e.$input.addClass(e.error_class);try{var s=t.keyCode||t.which;-1!==[13,27].indexOf(s)&&(e.close(),t.preventDefault())}catch(o){}}),this.$input},_createPopup:function(){var e=t("<div/>").addClass(this.popup_class).hide();this._createPalette(e),t("<div/>").css("clear","both").appendTo(e);var i=t("<div/>").addClass(this.bottom_class).appendTo(e);return this._createInputField().appendTo(i),this.show_field||i.hide(),e.prependTo(this.$element),e},_changePopupPosition:function(){var t=this.$element.css("padding-left").replace("px",""),e=this.$element.css("padding-top").replace("px",""),i=this.$element.css("border-left-width").replace("px","");return-1!==navigator.appVersion.indexOf("MSIE 8.")&&(t=parseInt(t,10)+this.$caption.outerWidth()),this.$popup.css({"margin-top":this.$element.outerHeight()-e,"margin-left":-t-i}),this},open:function(){return this.$popup.show(),this.isOpen=!0,this.$element.addClass(this.open_class),this.show_field&&this.$input.focus(),this},close:function(){return this.$popup.hide(),this.isOpen=!1,this.$element.removeClass(this.open_class),this._checkValidInput(),this},disable:function(){return this.disabled=!0,this.$element.addClass(this.disabled_class),this},enable:function(){return this.disabled=!1,this.$element.removeClass(this.disabled_class),this}},t.fn.colours=function(i,s){return this.each(function(){var o=t(this),n=o.data("Colours"),a="object"==typeof i&&i;if(n||o.data("Colours",n=new e(this,t.extend({},a))),"string"==typeof i){var h=!1,r=["palette","onPaletteOver","onPaletteOut","palette_size","palette_row_count"];r.indexOf(i)>-1&&(h=!0),n[i]=s,n.refresh(h)}})},t(".colours").colours()})(window.jQuery);